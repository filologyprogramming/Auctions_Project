{% extends "auctions/layout.html" %}

{% block body %}
    <h2>{{ listing.name }}</h2>

    <div class="row justify-content-evenly listing">
        <div class="col-6">
            {% if listing.active == False %}
                <h3 id="sold_to_banner">Sold to user {{ listing.sold_to }}</h3>
            {% endif %}

            <!-- Form to close a listing -->
            {% if listing.active == False %}
            <form inert action ="{% url 'close_listing' listing.id %}" method="post" name="close_listing" id="close_listing_form">
                {% elif user == listing.seller %}
                <form action ="{% url 'close_listing' listing.id %}" method="post" name="close_listing" id="close_listing_form">
                {% csrf_token %}
                <input type="hidden" value="{{ listing.id }}" name="listing_id" class="listing_id">
                <input type="submit" value="Close Listing" class="button" id="close_listing">
            </form>
            {% endif %}

            <!-- Listing -->
            <img src="{{ listing.image.url }}" alt="{{ listing.description }}">
            <div class="elo">
                <h4 class="listing-name">{{ listing.name }}</h4>
                <p class="listing-date">{{ listing.date }}</p>
            </div>
            
            <p class="listing-description">{{ listing.description }}</p>
            
            <p class="listing-seller">{{ listing.seller }}</p>
            <div class="listing-category">
                {{ listing.get_category_display }}
            </div>

            <!-- Actual live price -->
            <div id="button-and-form">
                {% if not bids %}
                <h4 class="listing-price" id="listing-price">PLN {{ listing.price }}</h4>
                {% else %}
                <h4 class="listing-price" id="listing-price">PLN {{highest_bid}}</h4>
                {% endif %}
                
                <!-- Add to watchlist form -->
                {% if listing.active == False %}
                <form inert action="{% url 'add_to_watchlist' listing.id %}" method="post" name="add_to_watchlist_form" id="add_to_watchlist_form">
                    {% else %}
                    <form action="{% url 'add_to_watchlist' listing.id %}" method="post" name="add_to_watchlist_form" id="add_to_watchlist_form">
                        {% csrf_token %}
                        <input type="hidden" value="{{ listing.id }}" name="listing_id" class="listing_id">
                        {% if listing in watchlist.listing.all %}
                        <input type="submit" value="Remove from watchlist" class="button" id="add_to_watchlist">
                        {% else %}
                        <input type="submit" value="Add to watchlist" class="button" id="add_to_watchlist">
                        {% endif %}
                    </form>
                    {% endif %}
                </form>
            </div>
        </div>
        <div class="col-6">

            <!-- History of bids -->
            {% if bids %}
            <div id="tabelka">
            <table>
                <caption>
                  <h4 id="table_caption">Highest bids</h4>
                </caption>
                <thead>
                  <tr>
                    <th scope="col">Price</th>
                    <th scope="col">User</th>
                  </tr>
                </thead>
                <tbody>
                    
                {% for bid in bids %}
                  <tr>
                    <td>{{bid.bid}}</td>
                    <td>{{bid.bidder}}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <h4 id="no_bids">No bids on this listing!</h4>
            {% endif %}



            <!-- Form and button for placing a bid -->
            {% if listing.active == False or user == listing.seller %}
             <div id="he"></div>
                <!-- <form inert action ="{% url 'place_a_bid' listing.id %}" method="post", name="place_a_bid_form" id="place_a_bid_form"> -->
            {% else %}
                <form action ="{% url 'place_a_bid' listing.id %}" method="post", name="place_a_bid_form" id="place_a_bid_form">
            {% csrf_token %}
                <input type="hidden" value="{{ listing.id }}" name="listing_id" class="listing_id">
                {% if bids %}
                    <input type="number" placeholder="{{ highest_bid }}" id="bid" min="{{ highest_bid_plus_1 }}" max="999999999999" step="0.01" required>
                    <input type="submit" class="button" value="Place a bid" id="place_a_bid">
                {% else %}
                    <input type="number" placeholder="{{ listing.price }}" id="bid" min="{{ listing.price }}" max="999999999999" step="0.01" required>
                    <input type="submit" class="button" value="Place a bid" id="place_a_bid">
                {% endif %}
                </form>
            {% endif %}

        </div>
    </div>
    <!-- Comment sections -->
    <div id="comment_section">
        <h4 id="comment_heading">Comments</h4>
        {% if listing.active == False %}
            <form action="{% url 'add_comment' listing.id %'}" method="post" class="comment_form" name="add_comment_form" id="add_comment_form">
        {% else %}
            <form action="{% url 'add_comment' listing.id %'}" method="post" class="comment_form" name="add_comment_form" id="add_comment_form">
                {% csrf_token %}
                <input type="hidden" value="{{ listing.id }}" name="listing_id" class="listing_id">
                {{ comment_form }}
                <input type="submit" value="Add Comment" class="button" id="add_comment">
            </form>
        {% endif %}

        <div>
            <p id="empty_comment">The comment cannot be empty</p>
        </div>

        <!-- Single comment -->
        <div id="all_comments_wrapper">
            {% for comment in comments %}
            <div class="one_comment_wrapper">
                <p class="comment">
                    {{ comment.comment }}
                </p>
                <p class="commenter">
                    {{ comment.user }}
                </p>
                <p class="comment_date">
                    {{ comment.date }}
                </p>
            </div>
        {% endfor %}
        </div>
    </div>

    <!-- Footer -->
     <footer>
        O moh chuj ale stopa!
     </footer>
{% endblock %}